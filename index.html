<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yhteinen sanaristikko (reaaliaikainen)</title>
  <style>
    :root { --cell: 32px; --gap: 2px; font-family: system-ui, sans-serif; }
    body { margin:0; background:#0b1116; color:#e6edf3; display:grid; place-items:center; min-height:100dvh; }
    .app { width:min(96vw,1100px); padding:20px; }
    h1 { font-size:20px; margin:0 0 8px 0; font-weight:600; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0 12px; }
    .toolbar button, .toolbar input[type="text"], .toolbar input[type="file"] { background:#0f1720; color:#e6edf3; border:1px solid #233041; border-radius:8px; padding:8px 10px; }
    .toolbar button:hover { background:#16263a; cursor:pointer; }
    .grid-wrapper { display:inline-block; }
    .labels-row, .grid-row { display:flex; }
    .label-cell { width:var(--cell); height:var(--cell); display:flex; align-items:center; justify-content:center; font-size:12px; opacity:.8; }
    .grid { display:grid; grid-template-columns: repeat(var(--n), var(--cell)); gap:var(--gap); background:#233041; padding:var(--gap); border-radius:8px; }
    .cell { width:var(--cell); height:var(--cell); display:grid; place-items:center; background:#152335; border-radius:4px; position:relative; }
    .cell input { width:100%; height:100%; text-align:center; font-weight:700; font-size:16px; text-transform:uppercase; background:transparent; border:none; color:#e6edf3; outline:none; }
    .cell.black { background:#070a10; outline:1px solid #2a3b52; }
    .cell.black input { visibility:hidden; pointer-events:none; }
    .cell.black::after { content:""; position:absolute; inset:0; border-radius:4px; background:repeating-linear-gradient(45deg, #0b0f17 0 8px, #101825 8px 16px); opacity:0.9; }
    .hint { font-size:12px; opacity:.8; margin-top:8px; }
  </style>
</head>
<body>
<div class="app">
  <h1 id="title">Yhteinen sanaristikko</h1>

  <div class="toolbar">
    <button id="save">Tallenna (.json)</button>
    <label>
      <input id="load" type="file" accept="application/json" style="display:none">
      <button id="loadBtn" type="button">Lataa (.json)</button>
    </label>
    <span style="flex:1"></span>
    <input id="roomName" type="text" placeholder="Huoneen nimi (esim. POP1)" />
    <button id="makeLink">Luo linkki</button>
    <a id="roomLink" href="#" target="_blank" style="text-decoration:underline; color:#8fd3ff; display:none">Avaa huone</a>
  </div>

  <div id="gridWrapper" class="grid-wrapper"></div>
  <div class="hint">Vinkki: Alt+klikkaa ruutua tehdäksesi siitä mustan/valkoisen. Vaihda huonetta lisäämällä osoitteeseen <code>?room=NIMI</code>.</div>
</div>

<script type="module">
// Moduliversio (toimii luotettavasti GitHub Pagesissa)
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.18/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket@1.5.4/+esm';

(function(){
  const params = new URLSearchParams(location.search);
  const room = (params.get('room')||'POP1').toLowerCase();
  document.getElementById('title').textContent = 'Sanaristikko '+room.toUpperCase();

  const ydoc = new Y.Doc();
  let provider = null;
  try {
    provider = new WebsocketProvider('wss://demos.yjs.dev', 'crossword-'+room, ydoc);
  } catch (e) {
    console.warn('Realtime-yhteyttä ei saatu, jatketaan paikallisesti', e);
  }
  const ycells = ydoc.getMap('cells');

  const N = 20;
  const gridWrapper = document.getElementById('gridWrapper');

  function keyFor(r,c){ return r+','+c; }
  function getCell(r,c){ const raw = ycells.get(keyFor(r,c)); return raw?JSON.parse(raw):{ v:'', b:false }; }
  function setCell(r,c,obj){ ycells.set(keyFor(r,c), JSON.stringify(obj)); }

  function render(){
    gridWrapper.innerHTML='';
    const topRow=document.createElement('div');
    topRow.className='labels-row';
    topRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); topRow.appendChild(l); }
    topRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(topRow);

    for(let r=0;r<N;r++){
      const row=document.createElement('div'); row.className='grid-row';
      const left=document.createElement('div'); left.className='label-cell'; left.textContent=r+1; row.appendChild(left);
      const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--n',N);
      for(let c=0;c<N;c++){
        const data=getCell(r,c);
        const cell=document.createElement('div');
        cell.className='cell'+(data.b?' black':'');
        const inp=document.createElement('input');
        inp.maxLength=1; inp.value=(data.v||'').toUpperCase();
        inp.addEventListener('input', e=>{
          const v=(e.target.value||'').replace(/[^A-Za-zÅÄÖåäö]/g,'').toUpperCase().slice(0,1);
          e.target.value=v; setCell(r,c,{v,b:data.b});
        });
        cell.appendChild(inp);
        cell.addEventListener('click', e=>{ if(e.altKey){ setCell(r,c,{v:data.v,b:!data.b}); }});
        grid.appendChild(cell);
      }
      row.appendChild(grid);
      const right=document.createElement('div'); right.className='label-cell'; right.textContent=r+1; row.appendChild(right);
      gridWrapper.appendChild(row);
    }
    const bottomRow=document.createElement('div'); bottomRow.className='labels-row';
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); bottomRow.appendChild(l); }
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(bottomRow);
  }

  ycells.observe(render);
  render();

  // --- TALLENNA / LATAA (JSON) ---
  function exportJSON(){
    const out = { n:N, cells:{} };
    for(let r=0;r<N;r++) for(let c=0;c<N;c++){
      const d = getCell(r,c);
      if(d.v || d.b) out.cells[keyFor(r,c)] = d;
    }
    const blob = new Blob([JSON.stringify(out)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ristikko-${room}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if(!data || !data.cells) throw new Error('Virheellinen tiedosto');
        ydoc.transact(()=>{
          ycells.clear();
          for(const k in data.cells){ ycells.set(k, JSON.stringify(data.cells[k])); }
        });
      } catch(e){ alert('Lataus epäonnistui: '+e.message); }
    };
    reader.readAsText(file);
  }
  document.getElementById('save').addEventListener('click', exportJSON);
  const loadInput = document.getElementById('load');
  document.getElementById('loadBtn').addEventListener('click', ()=> loadInput.click());
  loadInput.addEventListener('change', ()=>{ if(loadInput.files[0]) importJSON(loadInput.files[0]); });

  // --- HUONELINKKI ---
  const roomName = document.getElementById('roomName');
  const roomLink = document.getElementById('roomLink');
  document.getElementById('makeLink').addEventListener('click', ()=>{
    const name = (roomName.value || 'POP1').trim();
    const url = new URL(location.href);
    url.searchParams.set('room', name);
    roomLink.href = url.toString();
    roomLink.style.display = 'inline';
  });
})();
</script>
</body>
</html>
