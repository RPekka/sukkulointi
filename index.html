<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yhteinen sanaristikko (reaaliaikainen)</title>
  <style>
    :root { --cell: 32px; --gap: 2px; font-family: system-ui, sans-serif; }
    body { margin:0; background:#0b1116; color:#e6edf3; display:grid; place-items:center; min-height:100dvh; }
    .app { width:min(96vw,1100px); padding:20px; }
    h1 { font-size:20px; margin:0; font-weight:600; }
    .grid-wrapper { display:inline-block; }
    .labels-row, .grid-row { display:flex; }
    .label-cell { width:var(--cell); height:var(--cell); display:flex; align-items:center; justify-content:center; font-size:12px; opacity:.7; }
    .grid { display:grid; grid-template-columns: repeat(var(--n), var(--cell)); gap:var(--gap); background:#233041; padding:var(--gap); border-radius:8px; }
    .cell { width:var(--cell); height:var(--cell); display:grid; place-items:center; background:#0f1720; border-radius:4px; }
    .cell input { width:100%; height:100%; text-align:center; font-weight:700; font-size:16px; text-transform:uppercase; background:transparent; border:none; color:#e6edf3; outline:none; }
    .cell.black { background:#0b0e14; }
    .cell.black input { visibility:hidden; }
  </style>
</head>
<body>
<div class="app">
  <h1 id="title">Yhteinen sanaristikko</h1>
  <div id="gridWrapper" class="grid-wrapper"></div>
</div>

<script src="https://unpkg.com/yjs@13.6.18/dist/yjs.js"></script>
<script src="https://unpkg.com/y-websocket@1.5.4/dist/y-websocket.js"></script>
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const room = (params.get('room')||'POP1').toLowerCase();
  document.getElementById('title').textContent = 'Sanaristikko '+room.toUpperCase();

  const ydoc = new Y.Doc();
  const provider = new window.ywebsocket.WebsocketProvider('wss://demos.yjs.dev', 'crossword-'+room, ydoc);
  const ycells = ydoc.getMap('cells');

  const N = 20;
  const gridWrapper = document.getElementById('gridWrapper');

  function keyFor(r,c){ return r+','+c; }
  function getCell(r,c){ const raw = ycells.get(keyFor(r,c)); return raw?JSON.parse(raw):{ v:'', b:false }; }
  function setCell(r,c,obj){ ycells.set(keyFor(r,c), JSON.stringify(obj)); }

  function render(){
    gridWrapper.innerHTML='';
    // yläkirjaimet
    const topRow=document.createElement('div');
    topRow.className='labels-row';
    topRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); topRow.appendChild(l); }
    topRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(topRow);

    for(let r=0;r<N;r++){
      const row=document.createElement('div'); row.className='grid-row';
      const left=document.createElement('div'); left.className='label-cell'; left.textContent=r+1; row.appendChild(left);
      const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--n',N);
      for(let c=0;c<N;c++){
        const data=getCell(r,c);
        const cell=document.createElement('div');
        cell.className='cell'+(data.b?' black':'');
        const inp=document.createElement('input');
        inp.maxLength=1; inp.value=(data.v||'').toUpperCase();
        inp.addEventListener('input', e=>{
          const v=(e.target.value||'').replace(/[^A-Za-zÅÄÖåäö]/g,'').toUpperCase().slice(0,1);
          e.target.value=v; setCell(r,c,{v,b:data.b});
        });
        cell.appendChild(inp);
        cell.addEventListener('click', e=>{ if(e.altKey){ setCell(r,c,{v:data.v,b:!data.b}); }});
        grid.appendChild(cell);
      }
      row.appendChild(grid);
      const right=document.createElement('div'); right.className='label-cell'; right.textContent=r+1; row.appendChild(right);
      gridWrapper.appendChild(row);
    }
    // alarivi kirjaimet
    const bottomRow=document.createElement('div'); bottomRow.className='labels-row';
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); bottomRow.appendChild(l); }
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(bottomRow);
  }

  ycells.observe(render);
  render();
})();
</script>
</body>
</html>
