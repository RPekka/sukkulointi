<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Yhteinen sanaristikko (22x22, pilvisynkka)</title>

<!-- CSP: inline-skriptit sallittu jotta ruudukko piirtyy -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com;
               connect-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app;
               style-src 'self' 'unsafe-inline';
               img-src 'self' data:;
               frame-ancestors 'none';
               base-uri 'self';">

<style>
  :root { --cell: 34px; --gap: 2px; --n: 22; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
  body { margin:0; background:#f4f6fa; color:#0b1116; }
  .wrap { display:grid; grid-template-columns: 1fr 300px; gap:16px; align-items:start; width:min(98vw,1300px); margin:0 auto; padding:20px; }
  .right { position:sticky; top:12px; }

  h1 { font-size:22px; margin:0 0 6px 0; font-weight:700; }
  .subhint { font-size:14px; color:#334155; background:#e7eef9; border:1px solid #c9d9f8; padding:8px 10px; border-radius:10px; margin:6px 0 12px; }

  .status { font-size:12px; color:#475569; display:flex; align-items:center; gap:8px; margin-bottom:8px; }
  .dot { width:8px; height:8px; border-radius:50%; background:#94a3b8; }
  .dot.ok { background:#16a34a; }
  .dot.err { background:#ef4444; }

  /* Pelaajaluettelo otsikon alla */
  .players-line { font-size:13px; color:#334155; margin:6px 0 10px; }

  /* Lauta yhtenä gridinä */
  .board {
    display:inline-block;
    background:#d1d5db;
    padding:var(--gap);
    border:1px solid #d1d5db;
    border-radius:12px;
  }
  .board-grid{
    display:grid;
    grid-template-columns: var(--cell) repeat(var(--n), var(--cell)) var(--cell);
    grid-template-rows:    var(--cell) repeat(var(--n), var(--cell)) var(--cell);
    gap: var(--gap);
    background:#d1d5db;
    padding: var(--gap);
    border-radius:10px;
    box-sizing: border-box;
  }

  /* Tunnisteet */
  .label-cell{
    width:var(--cell); height:var(--cell);
    display:flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:700; color:#0b1116;
    background:#f8fafc; border:1px solid #e5e7eb; border-radius:6px;
  }

  /* Solut */
  .cell{
    width:var(--cell); height:var(--cell);
    display:grid; place-items:center;
    background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; position:relative;
  }
  .cell input{
    width:100%; height:100%;
    text-align:center; font-weight:800; font-size:18px; text-transform:uppercase;
    background:transparent; border:none; color:#0b1116; outline:none;
  }
  .cell input:disabled{
    opacity: 1;
    color: #0b1116;
    background: transparent;
    /* cursor: not-allowed; */ /* voit ottaa käyttöön jos haluat osoittimen kertovan ettei voi muokata */
  }
  .cell.black{ background:#0f1720; border-color:#0f1720; }
  .cell.black input{ visibility:hidden; pointer-events:none; }
  .cell.black::after{ content:""; position:absolute; inset:0; border-radius:6px;
    background:repeating-linear-gradient(45deg, #0f1720 0 8px, #142237 8px 16px); opacity:.9; }

  .disabled-overlay { pointer-events:none; opacity:.55; filter:grayscale(0.2); } /* ei käytössä enää */

  .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 0; }
  .toolbar button, .toolbar input[type="text"], .toolbar input[type="file"], .toolbar label { background:#ffffff; color:#0b1116; border:1px solid #cbd5e1; border-radius:10px; padding:8px 10px; }
  .toolbar button:hover { background:#f1f5f9; cursor:pointer; }
  .toolbar .grow { flex:1; }
  a.link { color:#0b6bcb; text-decoration:underline; }

  .card { background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; padding:12px; box-shadow:0 2px 10px #00000010; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
  .toggle { display:flex; align-items:center; gap:8px; font-size:14px; }
  .muted { color:#64748b; font-size:12px; }

  @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } .right{ position:static; } }
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h1 id="title">Sanaristikko</h1>
    <div class="subhint">Klikkaa ruutua ja lisää kirjain. Ristikon huone on nettiosoitteen lopussa, Pekka lähettää linkin.</div>

    <div class="status"><span id="statusDot" class="dot"></span><span id="statusText">Offline-tila (paikallinen)</span><span id="activeInfo" class="muted"></span></div>

    <!-- Pelaajaluettelo -->
    <div id="playersLine" class="players-line" aria-live="polite"></div>

    <div class="board"><div id="boardGrid" class="board-grid" role="grid" aria-label="Sanaristikon ruudukko"></div></div>

    <!-- Lukitus checkbox ristikon alle -->
    <div style="margin-top:10px;">
      <label class="toggle"><input type="checkbox" id="lockBlack"> <span>Lukitse mustat ruudut</span></label>
    </div>

    <!-- Paikallinen työkalurivi -->
    <div class="toolbar" id="toolbar">
      <button id="save">Tallenna (.json)</button>
      <label>
        <input id="load" type="file" accept="application/json" style="display:none">
        <button id="loadBtn" type="button">Lataa (.json)</button>
      </label>
      <button id="clear">Tyhjennä ristikko (huone)</button>
      <span class="grow"></span>
      <input id="roomName" type="text" placeholder="Huoneen nimi (esim. POP1)" />
      <input id="roomTitle" type="text" placeholder="Huoneen otsikko (näkyy ylhäällä)" />
      <button id="makeLink">Luo linkki</button>
      <a id="roomLink" class="link" href="#" target="_blank" rel="noopener noreferrer" style="display:none">Avaa huone</a>
    </div>
  </div>

  <div class="right">
    <div class="card" style="margin-bottom:12px;">
      <div style="font-weight:600; margin-bottom:8px;">Pelaa Firebase-pilvessä</div>

      <!-- Alasvetovalikko: kiinteä nimilista -->
      <select id="playerSelect" style="width:100%; margin-bottom:10px;">
        <option value="">— Valitse nimesi —</option>
        <option>Enni</option><option>Esme</option><option>Marika</option>
        <option>Mauri</option><option>Mirva</option><option>Pekka</option>
        <option>Pertti</option><option>Petri</option><option>Sini</option>
        <option>Taru</option><option>Teemu</option>
      </select>

      <!-- Ylärivi -->
      <div class="btn-row" style="margin-bottom:8px;">
        <button id="cloudLoad">Lataa pilvestä</button>
        <button id="signIn">Kirjaudu</button>
      </div>

      <!-- Keskirivi -->
      <div class="btn-row" style="margin-bottom:8px;">
        <button id="takeTurn" disabled>Ota vuoro</button>
        <button id="releaseTurn" disabled>Luovuta vuoro</button>
      </div>

      <!-- Alarivi -->
      <div class="btn-row">
        <button id="quitApp">Lopeta</button>
        <button id="sendMessage">Lähetä viesti</button>
      </div>
    </div>

    <!-- Tallennus/versiot – näkyy vain Pekalle -->
    <div id="versionsCard" class="card" style="display:none;">
      <div style="font-weight:600; margin-bottom:8px;">Tallennukset (Pekka)</div>
      <div class="btn-row" style="margin-bottom:8px;">
        <button id="refreshSnapshots">Päivitä lista</button>
      </div>
      <div id="snapshotsList" class="muted">Ei tallennuksia vielä.</div>
    </div>
  </div>
</div>

<script type="module">
// ——— Asetukset ———
const N = 22; document.documentElement.style.setProperty('--n', N);
const SNAPSHOT_LIMIT = 5;

const params = new URLSearchParams(location.search);
const mode = (params.get('mode')||'offline').toLowerCase();
const room = (params.get('room')||'POP1').trim();
const dbURL = (params.get('db')||'').replace(/\/$/, '');
const authToken = (params.get('auth')||'').trim(); // valinnainen

// Otsikko & status
const titleEl = document.getElementById('title');
const playersLineEl = document.getElementById('playersLine');
function setHeader(roomName, title){ titleEl.textContent = 'Sanaristikko '+roomName.toUpperCase()+ (title? ' — '+title : ''); }
const statusDot = document.getElementById('statusDot'); const statusText = document.getElementById('statusText'); const activeInfo = document.getElementById('activeInfo');
function setStatus(cls, msg){ statusDot.classList.remove('ok','err'); if(cls) statusDot.classList.add(cls); statusText.textContent = msg; }
function setActiveInfoTxt(txt){ activeInfo.textContent = txt? ' — '+txt : ''; }
function renderPlayersLine(playersObj){
  const names = Object.keys(playersObj||{}).filter(k=>playersObj[k]);
  playersLineEl.textContent = names.length ? ('pelaajat: ' + names.join(', ')) : '';
}
function fmt(ts){
  const d = new Date(ts);
  const pad = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// Tilat
const grid = document.getElementById('boardGrid');
const lockBlackEl = document.getElementById('lockBlack');
function keyFor(r,c){ return r+','+c; }
const Store = {
  cells:{},
  state:{lockBlack:true},
  players:{},       // kirjautuneet { nimi: true }
  active:null,      // { name, since } tai null
  myName:'',        // oma nimi
  meta:{title:''},
  updatedAt:0
};

function canEdit(){
  // Offline: vapaa muokkaus
  if (!cloud.enabled) return true;
  // Pilvi: vain vuoronhaltija
  return !!(Store.active && Store.active.name === Store.myName);
}
function applyEditability(){
  const editable = canEdit();
  grid.classList.remove('disabled-overlay');
  document.querySelectorAll('.cell input').forEach(inp=>{
    if (editable) {
      inp.removeAttribute('disabled');
      inp.style.cursor = '';
    } else {
      inp.setAttribute('disabled','true');
      inp.style.cursor = 'not-allowed';
    }
  });
}

// Piirto
function render(){
  grid.innerHTML='';

  // Ylärivin kirjaimet
  for(let c=0;c<N;c++){
    const d=document.createElement('div'); d.className='label-cell';
    d.textContent = String.fromCharCode(65+c);
    d.style.gridRow = '1'; d.style.gridColumn = (2+c).toString();
    grid.appendChild(d);
  }
  // Alarivin kirjaimet
  for(let c=0;c<N;c++){
    const d=document.createElement('div'); d.className='label-cell';
    d.textContent = String.fromCharCode(65+c);
    d.style.gridRow = (N+2).toString(); d.style.gridColumn = (2+c).toString();
    grid.appendChild(d);
  }
  // Vasemman reunan numerot
  for(let r=0;r<N;r++){
    const d=document.createElement('div'); d.className='label-cell';
    d.textContent = (r+1).toString();
    d.style.gridColumn = '1'; d.style.gridRow = (2+r).toString();
    grid.appendChild(d);
  }
  // Oikean reunan numerot
  for(let r=0;r<N;r++){
    const d=document.createElement('div'); d.className='label-cell';
    d.textContent = (r+1).toString();
    d.style.gridColumn = (N+2).toString(); d.style.gridRow = (2+r).toString();
    grid.appendChild(d);
  }
  // Sisäruudukko
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const data=Store.cells[keyFor(r,c)]||{v:'',b:false};
      const cell=document.createElement('div'); cell.className='cell'+(data.b?' black':'');
      cell.setAttribute('role','gridcell');
      cell.style.gridRow = (2+r).toString(); cell.style.gridColumn = (2+c).toString();

      const inp=document.createElement('input');
      inp.maxLength = 1;
      inp.value = (data.v||'').toUpperCase();
      inp.dataset.r = r;
      inp.dataset.c = c;
      // input-attribuutit
      inp.setAttribute('inputmode','latin');
      inp.setAttribute('autocomplete','off');
      inp.setAttribute('autocapitalize','off');
      inp.setAttribute('autocorrect','off');
      inp.setAttribute('spellcheck','false');
      inp.setAttribute('aria-label', `Rivi ${r+1}, Sarake ${c+1}`);

      inp.addEventListener('input', e=>{
        if(!canEdit()) return;
        const v=(e.target.value||'').replace(/[^A-Za-zÅÄÖåäö]/g,'').toUpperCase().slice(0,1);
        e.target.value=v; Store.cells[keyFor(r,c)] = { v, b:data.b }; if(v){ move(r,c,'right'); }
      });
      inp.addEventListener('keydown', e=>{
        if(!canEdit() && ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Backspace','Enter'].includes(e.key)) { e.preventDefault(); return; }
        if(e.key==='ArrowLeft'){ e.preventDefault(); move(r,c,'left'); }
        else if(e.key==='ArrowRight' || e.key==='Enter'){ e.preventDefault(); move(r,c,'right'); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); move(r,c,'up'); }
        else if(e.key==='ArrowDown'){ e.preventDefault(); move(r,c,'down'); }
        else if(e.key==='Backspace'){
          if(inp.value){ e.preventDefault(); Store.cells[keyFor(r,c)] = { v:'', b:data.b }; inp.value=''; }
          else { e.preventDefault(); const nc=Math.max(0,c-1); const k=keyFor(r,nc); const prev=Store.cells[k]||{v:'',b:false}; Store.cells[k] = { ...prev, v:'' }; focusRC(r,nc); }
        }
      });
      cell.addEventListener('click', e=>{
        if((e.altKey) && Store.state && !Store.state.lockBlack && canEdit()){
          Store.cells[keyFor(r,c)] = { v:data.v, b:!data.b }; render();
        }
      });
      grid.appendChild(cell);
    }
  }
  applyEditability();
}

function focusRC(r,c){ const el = document.querySelector(`.cell input[data-r="${r}"][data-c="${c}"]`); if(el){ el.focus(); el.select(); } }
function move(r,c,dir){ if(dir==='left') c=Math.max(0,c-1); if(dir==='right') c=Math.min(N-1,c+1); if(dir==='up') r=Math.max(0,r-1); if(dir==='down') r=Math.min(N-1,r+1); focusRC(r,c); }

// ——— Pilvi ———
let cloudLoadedOnce = false;

const cloud = {
  enabled: mode==='firebase' && dbURL,

  pathRoom(){
    const base = `${dbURL}/rooms/${encodeURIComponent(room)}.json`;
    return authToken ? `${base}?auth=${encodeURIComponent(authToken)}` : base;
  },

  // Snapshottien polut
  pathSnapshots(){
    const base = `${dbURL}/rooms/${encodeURIComponent(room)}/snapshots.json`;
    return authToken ? `${base}?auth=${encodeURIComponent(authToken)}` : base;
  },
  pathSnapshotsChild(id){
    const base = `${dbURL}/rooms/${encodeURIComponent(room)}/snapshots/${id}.json`;
    return authToken ? `${base}?auth=${encodeURIComponent(authToken)}` : base;
  },

  // Huoneen luku/kirjoitus
  async read(){
    const res = await fetch(this.pathRoom());
    if(!res.ok) throw new Error('Luku epäonnistui');
    return res.json();
  },
  async write(obj){
    const res = await fetch(this.pathRoom(), {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(obj)
    });
    if(!res.ok) throw new Error('Kirjoitus epäonnistui');
    return res.json();
  },

  // Snapshottien luku/lisäys/poisto
  async readSnapshots(){
    const res = await fetch(this.pathSnapshots());
    if(!res.ok) throw new Error('Snap-luku epäonnistui');
    return res.json();
  },
  async appendSnapshot(id, snap){
    // tärkeää: kääre { [id]: snap } → ei ylikirjoita koko solmua
    const res = await fetch(this.pathSnapshots(), {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ [id]: snap })
    });
    if(!res.ok) throw new Error('Snap-lisäys epäonnistui');
    return res.json();
  },
  async deleteSnapshot(id){
    const res = await fetch(this.pathSnapshotsChild(id), { method:'DELETE' });
    if(!res.ok) throw new Error('Snap-poisto epäonnistui');
    return true;
  },

  // Lataa huone pilvestä ja päivitä paikallinen tila
  async load(){
    const data = await this.read(); if(!data) return;
    Store.cells     = data.cells   || {};
    Store.state     = data.state   || {lockBlack:true};
    Store.players   = data.players || {};
    Store.active    = data.active  || null;
    Store.meta      = data.meta    || {title:''};
    Store.updatedAt = data.updatedAt || 0;

    setHeader(room, Store.meta.title || '');
    renderPlayersLine(Store.players);
    setActiveInfoTxt(Store.active ? `Vuoro: ${Store.active.name}` : 'Ei lukkoa');

    cloudLoadedOnce = true;
    render();
    applyEditability(); // pidä ruudukko vaaleana, estä syöttö ilman vuoroa
  },

  // Kirjoita tämänhetkinen "live"-tila (ei snapshot-listaa)
  async saveCurrentOnly(){
    const payload = {
      cells:   Store.cells,
      state:   Store.state,
      players: Store.players,
      active:  Store.active,
      meta:    Store.meta,
      updatedAt: Date.now()
    };
    await this.write(payload);
    Store.updatedAt = payload.updatedAt;
  }
};

// UI-elementit
const playerSelect = document.getElementById('playerSelect');
const takeTurnBtn = document.getElementById('takeTurn');
const releaseTurnBtn = document.getElementById('releaseTurn');
const cloudLoadBtn = document.getElementById('cloudLoad');
const signInBtn = document.getElementById('signIn');
const quitBtn = document.getElementById('quitApp');
const sendMsgBtn = document.getElementById('sendMessage'); // ei toimintoa vielä

// Pekka-versiopaneeli
const versionsCard = document.getElementById('versionsCard');
const refreshSnapshotsBtn = document.getElementById('refreshSnapshots');
const snapshotsList = document.getElementById('snapshotsList');

function showVersionsCardIfPekka(){
  versionsCard.style.display = (Store.myName === 'Pekka' && cloud.enabled) ? 'block' : 'none';
}

function renderSnapshotsList(snapshotsObj){
  if(!snapshotsObj || Object.keys(snapshotsObj).length===0){
    snapshotsList.innerHTML = '<span class="muted">Ei tallennuksia vielä.</span>';
    return;
  }
  // Järjestä uusin ensin ts:n mukaan
  const arr = Object.entries(snapshotsObj).map(([id,v])=>({ id, ...v }));
  arr.sort((a,b)=> (b.ts||0)-(a.ts||0));
  snapshotsList.innerHTML = '';
  arr.forEach(sn=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.padding='6px 0'; row.style.borderBottom='1px solid #e5e7eb';

    const left = document.createElement('div');
    left.innerHTML = `<div><b>${sn.label||'Tallennus'}</b></div><div class="muted">${fmt(sn.ts||0)} — ${sn.by||''}</div>`;

    const btn = document.createElement('button');
    btn.textContent = 'Palauta';
    btn.addEventListener('click', async ()=>{
      if(!cloud.enabled){ alert('Ei pilviyhteyttä'); return; }
      if(!confirm(`Palautetaanko tallennus:\n${sn.label||fmt(sn.ts)} ?`)) return;
      try{
        // Lue uusin room-obj, korvaa cells/state/meta (players/active ennallaan)
        const base = await cloud.read() || {};
        base.cells = sn.cells || {};
        base.state = sn.state || {lockBlack:true};
        base.meta  = sn.meta  || base.meta || {};
        base.updatedAt = Date.now();
        await cloud.write(base);

        // Päivitä paikallinen
        Store.cells = base.cells; Store.state = base.state; Store.meta = base.meta; Store.updatedAt = base.updatedAt;
        render(); applyEditability();
        alert('Versio palautettu käyttöön.');
      } catch(e){
        alert('Palautus epäonnistui');
      }
    });

    row.appendChild(left);
    row.appendChild(btn);
    snapshotsList.appendChild(row);
  });
}

refreshSnapshotsBtn?.addEventListener('click', async ()=>{
  try{
    const snaps = await cloud.readSnapshots();
    renderSnapshotsList(snaps);
  }catch(e){
    alert('Tallennuslistan haku epäonnistui');
  }
});

// Päivitä UI-tilat nimen ja pilven mukaan
function refreshButtons(){
  takeTurnBtn.disabled = !Store.myName || !cloud.enabled;
  releaseTurnBtn.disabled = !(Store.active && Store.active.name===Store.myName);
  showVersionsCardIfPekka();
}

lockBlackEl?.addEventListener('change', ()=>{
  Store.state.lockBlack = !!lockBlackEl.checked;
  applyEditability();
});

// Lataa pilvestä
cloudLoadBtn?.addEventListener('click', async ()=>{
  if(!cloud.enabled){ alert('Ei pilviyhteyttä: URLiin ?mode=firebase&db=...&room=...'); return; }
  try{
    await cloud.load();
    setStatus('ok','Firebase-yhteys OK');
    startPoll();
    refreshButtons();
    applyEditability();
  } catch(e){
    setStatus('err','Pilvilataus epäonnistui');
  }
});

// Kirjaudu (alasvetovalikosta)
signInBtn?.addEventListener('click', async ()=>{
  if(!cloud.enabled){ alert('Ei pilviyhteyttä'); return; }
  const name = (playerSelect.value || '').trim();
  if(!name){ alert('Valitse nimesi listasta'); return; }

  Store.myName = name;
  try{
    const data = await cloud.read();
    const base = data || {cells:{}, state:{lockBlack:true}, players:{}, active:null, meta:{title:''}, updatedAt:0};
    base.players = base.players || {};
    base.players[name] = true;
    base.updatedAt = Date.now();
    await cloud.write(base);

    Store.players = base.players;
    Store.updatedAt = base.updatedAt;
    renderPlayersLine(Store.players);
    refreshButtons();
    applyEditability();
  } catch(e){
    alert('Kirjautuminen epäonnistui');
  }
});

// Vuorologiikka
async function writeActive(to){
  try{
    const data = await cloud.read();
    const base = data||{cells:{},state:{lockBlack:true},players:{},meta:{title: Store.meta.title||''}};
    base.active = to; base.updatedAt = Date.now();
    await cloud.write(base);
    Store.active = to; Store.updatedAt = base.updatedAt; Store.meta = base.meta;
    setHeader(room, Store.meta.title||''); setActiveInfoTxt(Store.active? `Vuoro: ${Store.active.name}` : 'Ei lukkoa'); applyEditability();
  } catch(e){ alert('Vuoron kirjaus epäonnistui'); }
}

takeTurnBtn?.addEventListener('click', async ()=>{
  if(!Store.myName){ alert('Kirjaudu ensin'); return; }
  if(!cloud.enabled){ alert('Pilvimoodi ei ole käytössä'); return; }
  await writeActive({ name: Store.myName, since: Date.now() });
  refreshButtons();
});

async function saveSnapshot(label){
  const now = Date.now();
  const id = `${now}_${Math.random().toString(36).slice(2,7)}`; // uniikki avain

  const snap = {
    ts: now,
    by: Store.myName || '',
    label: label || `Luovutus — ${Store.myName||''} — ${fmt(now)}`,
    cells: Store.cells,
    state: Store.state,
    meta:  Store.meta
  };

  // 1) Päivitä live-tila (huoneen nykyinen ristikko)
  await cloud.saveCurrentOnly();

  // 2) Lisää snapshot ilman ylikirjoitusta
  await cloud.appendSnapshot(id, snap);

  // 3) Pidä vain uusimmat SNAPSHOT_LIMIT kappaletta
  const current = await cloud.readSnapshots() || {};
  const entries = Object.entries(current); // [[id, snap], ...]
  entries.sort((a,b)=> (b[1].ts||0) - (a[1].ts||0)); // uusin ensin
  const extra = entries.slice(SNAPSHOT_LIMIT);
  for (const [oldId] of extra){
    await cloud.deleteSnapshot(oldId);
  }
}

releaseTurnBtn?.addEventListener('click', async ()=>{
  if(Store.active && Store.active.name!==Store.myName){ alert(`Vuoro on ${Store.active.name}`); return; }
  if(!cloud.enabled){ alert('Pilvimoodi ei ole käytössä'); return; }
  try{
    // AUTOMAATTINEN TALLENNUS + VERSIOINTI
    await saveSnapshot(`Luovutus — ${Store.myName||''} — ${fmt(Date.now())}`);
  }catch(e){
    alert('Tallennus ennen luovutusta epäonnistui'); return;
  }
  // VAPAUTA VUORO
  await writeActive(null);
  refreshButtons();
  applyEditability();

  // Päivitä lista heti (vain Pekalle näkyvässä paneelissa)
  try { await refreshSnapshotsBtn?.click(); } catch {}
});

// Lopeta (uloskirjaus; vapauta vuoro jos oli; poista nimesi players-listasta)
quitBtn?.addEventListener('click', async ()=>{
  if(!Store.myName){ return; }
  try{
    const data = await cloud.read();
    const base = data || {cells:{}, state:{lockBlack:true}, players:{}, active:null, meta:{title:''}, updatedAt:0};

    // jos minulla on vuoro, tee snapshot ja vapauta
    if(base.active && base.active.name === Store.myName){
      await saveSnapshot(`Lopetus — ${Store.myName} — ${fmt(Date.now())}`);
      base.active = null;
    }
    // poista pelaajista
    if(base.players && base.players[Store.myName]){
      delete base.players[Store.myName];
    }
    base.updatedAt = Date.now();
    await cloud.write(base);

    // paikallinen uloskirjaus
    Store.players = base.players || {};
    Store.active = base.active || null;
    setActiveInfoTxt(Store.active? `Vuoro: ${Store.active.name}` : 'Ei lukkoa');
    renderPlayersLine(Store.players);

    Store.myName = '';
    playerSelect.value = '';
    refreshButtons();
    applyEditability();
  } catch(e){
    alert('Uloskirjautuminen epäonnistui');
  }
});

// ——— JSON-varmuuskopio (sis. otsikon) ———
document.getElementById('save').addEventListener('click', ()=>{
  const out = { n: N, cells: Store.cells, state: Store.state, meta: Store.meta, updatedAt: Store.updatedAt || Date.now() };
  const blob = new Blob([JSON.stringify(out)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ristikko-${room}.json`; a.click(); URL.revokeObjectURL(a.href);
});
const loadInput = document.getElementById('load');
document.getElementById('loadBtn').addEventListener('click', ()=> loadInput.click());
loadInput.addEventListener('change', ()=>{
  if(loadInput.files[0]){
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const data=JSON.parse(reader.result);
        if(!data||!data.cells) throw new Error('Virheellinen tiedosto');
        Store.cells=data.cells;
        if(data.state) Store.state=data.state;
        if(data.meta)  Store.meta=data.meta;
        if(data.updatedAt) Store.updatedAt=data.updatedAt;
        setHeader(room, Store.meta.title || '');
        render(); applyEditability();
      } catch(e){ alert('Lataus epäonnistui: '+e.message); }
    };
    reader.readAsText(loadInput.files[0]);
  }
});

document.getElementById('clear').addEventListener('click', ()=>{
  if(confirm('Tyhjennetäänkö koko ristikko tältä huoneelta?')){
    Store.cells={}; render(); applyEditability();
  }
});

// Linkkigeneraattori
const roomNameEl = document.getElementById('roomName');
const roomTitleEl = document.getElementById('roomTitle');
const roomLink = document.getElementById('roomLink');

async function createRoomInCloud(name, title){
  if(!dbURL){ alert('Lisää URL-parametrit: ?mode=firebase&db=...'); return; }
  const pathBase = `${dbURL.replace(/\/$/,'')}/rooms/${encodeURIComponent(name)}.json`;
  const baseURL = authToken ? `${pathBase}?auth=${encodeURIComponent(authToken)}` : pathBase;
  try{
    const cur = await fetch(baseURL); const curData = cur.ok? await cur.json() : null;
    const payload = curData || { cells:{}, state:{lockBlack:true}, players:{}, active:null, meta:{title:''}, updatedAt:0 };
    payload.meta.title = title||payload.meta.title||'';
    if(!curData){ payload.updatedAt = Date.now(); }
    await fetch(baseURL, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  } catch(e){ alert('Huoneen luonti pilveen epäonnistui'); }
}

document.getElementById('makeLink').addEventListener('click', async ()=>{
  const name = (roomNameEl.value || room).trim();
  const title = (roomTitleEl.value || '').trim();
  if(mode==='firebase' && dbURL){ await createRoomInCloud(name, title); }
  const url = new URL(location.href); url.searchParams.set('room', name); url.searchParams.set('mode','firebase'); url.searchParams.set('db', dbURL);
  if(authToken) url.searchParams.set('auth', authToken);
  roomLink.href = url.toString(); roomLink.style.display='inline'; roomLink.textContent='Avaa huone: '+name+(title? ' — '+title : '');
});

// Poll
let pollHandle = null;
function startPoll(){
  if(pollHandle) return;
  pollHandle = setInterval(async ()=>{
    try{
      const data = await cloud.read(); if(!data) return;
      if(data.updatedAt && data.updatedAt !== Store.updatedAt){
        Store.cells = data.cells||{}; Store.state = data.state||{lockBlack:true};
        Store.players = data.players||{};
        Store.active = data.active||null; Store.meta = data.meta||{title:''}; Store.updatedAt = data.updatedAt;
        render(); applyEditability();
      } else {
        Store.players = data.players||Store.players;
        Store.active = data.active||Store.active;
      }
      setHeader(room, (data.meta && data.meta.title) || Store.meta.title || '');
      renderPlayersLine(Store.players);
      setActiveInfoTxt(Store.active? `Vuoro: ${Store.active.name}` : 'Ei lukkoa');
      showVersionsCardIfPekka();
    } catch{}
  }, 2000);
}

// Init
(function init(){
  lockBlackEl.checked = !!Store.state.lockBlack;
  setHeader(room, '');
  render(); applyEditability();
  if(mode==='firebase' && dbURL){ setStatus('', 'Valmis Firebaseen – paina "Lataa pilvestä"'); } else { setStatus('', 'Offline-tila (paikallinen)'); }
})();
</script>
</body>
</html>
