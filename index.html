<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yhteinen sanaristikko (reaaliaikainen)</title>
  <style>
    :root { --cell: 34px; --gap: 2px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
    body { margin:0; background:#f4f6fa; color:#0b1116; display:grid; place-items:center; min-height:100dvh; }
    .app { width:min(96vw,1100px); padding:20px; }
    h1 { font-size:22px; margin:0 0 6px 0; font-weight:700; }
    .subhint { font-size:14px; color:#334155; background:#e7eef9; border:1px solid #c9d9f8; padding:8px 10px; border-radius:10px; margin:6px 0 12px; }
    .grid-wrapper { display:inline-block; background:#e5e7eb; padding:8px; border-radius:12px; border:1px solid #d1d5db; }
    .labels-row, .grid-row { display:flex; }
    .label-cell { width:var(--cell); height:var(--cell); display:flex; align-items:center; justify-content:center; font-size:12px; color:#425466; }
    .grid { display:grid; grid-template-columns: repeat(var(--n), var(--cell)); gap:var(--gap); background:#d1d5db; padding:var(--gap); border-radius:8px; }
    .cell { width:var(--cell); height:var(--cell); display:grid; place-items:center; background:#ffffff; border-radius:6px; position:relative; border:1px solid #e5e7eb; }
    .cell input { width:100%; height:100%; text-align:center; font-weight:800; font-size:18px; text-transform:uppercase; background:transparent; border:none; color:#0b1116; outline:none; }
    .cell.black { background:#0f1720; border-color:#0f1720; }
    .cell.black input { visibility:hidden; pointer-events:none; }
    .cell.black::after { content:""; position:absolute; inset:0; border-radius:6px; background:repeating-linear-gradient(45deg, #0f1720 0 8px, #142237 8px 16px); opacity:.9; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:12px 0 0; }
    .toolbar button, .toolbar input[type="text"], .toolbar input[type="file"] { background:#ffffff; color:#0b1116; border:1px solid #cbd5e1; border-radius:10px; padding:8px 10px; }
    .toolbar button:hover { background:#f1f5f9; cursor:pointer; }
    .toolbar .grow { flex:1; }
    a.link { color:#0b6bcb; text-decoration:underline; }
  </style>
</head>
<body>
<div class="app">
  <h1 id="title">Sanaristikko</h1>
  <div class="subhint">Klikkaa ruutua ja lisää kirjain. Ristikon huone on nettiosoitteen lopussa, Pekka lähettää linkin.</div>

  <div id="gridWrapper" class="grid-wrapper"></div>

  <div class="toolbar" id="toolbar">
    <button id="save">Tallenna (.json)</button>
    <label>
      <input id="load" type="file" accept="application/json" style="display:none">
      <button id="loadBtn" type="button">Lataa (.json)</button>
    </label>
    <span class="grow"></span>
    <input id="roomName" type="text" placeholder="Huoneen nimi (esim. POP1)" />
    <input id="titleAppend" type="text" placeholder="Otsikko (näytetään nimen perässä)" />
    <button id="makeLink">Luo linkki</button>
    <a id="roomLink" class="link" href="#" target="_blank" style="display:none">Avaa huone</a>
  </div>
</div>

<script type="module">
import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.18/+esm';
import { WebsocketProvider } from 'https://cdn.jsdelivr.net/npm/y-websocket@1.5.4/+esm';

(function(){
  const params = new URLSearchParams(location.search);
  const room = (params.get('room')||'POP1').trim();
  const extraTitle = (params.get('title')||'').trim();
  updateHeader(room, extraTitle);

  const ydoc = new Y.Doc();
  try { new WebsocketProvider('wss://demos.yjs.dev', 'crossword-'+room.toLowerCase(), ydoc); } catch(e) { console.warn('Realtime-yhteyttä ei saatu:', e); }
  const ycells = ydoc.getMap('cells');

  const N = 20;
  const gridWrapper = document.getElementById('gridWrapper');
  function keyFor(r,c){ return r+','+c; }
  function getCell(r,c){ const raw = ycells.get(keyFor(r,c)); return raw?JSON.parse(raw):{ v:'', b:false }; }
  function setCell(r,c,obj){ ycells.set(keyFor(r,c), JSON.stringify(obj)); }

  function render(){
    gridWrapper.innerHTML='';
    const topRow=document.createElement('div');
    topRow.className='labels-row';
    topRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); topRow.appendChild(l); }
    topRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(topRow);

    for(let r=0;r<N;r++){
      const row=document.createElement('div'); row.className='grid-row';
      const left=document.createElement('div'); left.className='label-cell'; left.textContent=r+1; row.appendChild(left);
      const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--n',N);
      for(let c=0;c<N;c++){
        const data=getCell(r,c);
        const cell=document.createElement('div');
        cell.className='cell'+(data.b?' black':'');
        const inp=document.createElement('input');
        inp.maxLength=1; inp.value=(data.v||'').toUpperCase();
        inp.addEventListener('input', e=>{
          const v=(e.target.value||'').replace(/[^A-Za-zÅÄÖåäö]/g,'').toUpperCase().slice(0,1);
          e.target.value=v; setCell(r,c,{v,b:data.b});
        });
        cell.appendChild(inp);
        cell.addEventListener('click', e=>{ if(e.altKey){ setCell(r,c,{v:data.v,b:!data.b}); }});
        grid.appendChild(cell);
      }
      row.appendChild(grid);
      const right=document.createElement('div'); right.className='label-cell'; right.textContent=r+1; row.appendChild(right);
      gridWrapper.appendChild(row);
    }
    const bottomRow=document.createElement('div'); bottomRow.className='labels-row';
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    for(let c=0;c<N;c++){ const l=document.createElement('div'); l.className='label-cell'; l.textContent=String.fromCharCode(65+c); bottomRow.appendChild(l); }
    bottomRow.appendChild(document.createElement('div')).className='label-cell';
    gridWrapper.appendChild(bottomRow);
  }

  ycells.observe(render); render();

  // Tallennus / lataus
  function exportJSON(){
    const out = { n:N, cells:{} };
    for(let r=0;r<N;r++) for(let c=0;c<N;c++){
      const d = getCell(r,c);
      if(d.v || d.b) out.cells[keyFor(r,c)] = d;
    }
    const blob = new Blob([JSON.stringify(out)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ristikko-${room}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if(!data || !data.cells) throw new Error('Virheellinen tiedosto');
        ydoc.transact(()=>{ ycells.clear(); for(const k in data.cells){ ycells.set(k, JSON.stringify(data.cells[k])); } });
      } catch(e){ alert('Lataus epäonnistui: '+e.message); }
    };
    reader.readAsText(file);
  }
  document.getElementById('save').addEventListener('click', exportJSON);
  const loadInput = document.getElementById('load');
  document.getElementById('loadBtn').addEventListener('click', ()=> loadInput.click());
  loadInput.addEventListener('change', ()=>{ if(loadInput.files[0]) importJSON(loadInput.files[0]); });

  // Huonelinkki (nimi + otsikko)
  const roomName = document.getElementById('roomName');
  const titleAppend = document.getElementById('titleAppend');
  const roomLink = document.getElementById('roomLink');
  document.getElementById('makeLink').addEventListener('click', ()=>{
    const name = (roomName.value || 'POP1').trim();
    const extra = (titleAppend.value || '').trim();
    const url = new URL(location.href);
    url.searchParams.set('room', name);
    if(extra) url.searchParams.set('title', extra);
    roomLink.href = url.toString();
    roomLink.style.display = 'inline';
    roomLink.textContent = 'Avaa huone: '+name+(extra? ' — '+extra : '');
  });

  function updateHeader(roomName, extra){
    const t = document.getElementById('title');
    t.textContent = 'Sanaristikko '+roomName.toUpperCase()+ (extra? ' — '+extra : '');
  }
})();
</script>
</body>
</html>
